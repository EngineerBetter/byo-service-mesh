applications:
- name: consul-server
  buildpacks:
  - binary_buildpack
  health-check-type: http
  health-check-http-endpoint: /ui/
  command: >-
    ./consul agent -server -ui
    -client 0.0.0.0 -http-port $PORT
    -node consul-server-$CF_INSTANCE_GUID
    -data-dir /tmp/consul
    -config-file enable-connect.hcl
    -bootstrap-expect 3
    -retry-join 0.consul-server.apps.internal
    -retry-join 1.consul-server.apps.internal
    -retry-join 2.consul-server.apps.internal
  instances: 3
  memory: 256M
  routes:
  - route: consul-server.apps.internal
  - route: eb-consul.cfapps.io
  env:
    CONSUL_HTTP_ADDR: localhost:8080

- name: frontend
  buildpacks:
  - python_buildpack
  memory: 128M
  no-route: true
  processes:
  - type: web
    command: python -m http.server $PORT
    memory: 256M
  sidecars:
  - name: consul
    process_types: [web]
    memory: 32M
    command: >-
      ./consul agent
      -node frontend-$CF_INSTANCE_GUID
      -data-dir /tmp/consul
      -join consul-server.apps.internal
      -config-file frontend.json
      -enable-local-script-checks
  - name: consul-proxy
    process_types: [web]
    memory: 64M
    command: sleep 10 && ./consul connect proxy -sidecar-for frontend

- name: backend
  buildpacks:
  - python_buildpack
  routes:
  - route: eb-backend.apps.internal
  processes:
  - type: web
    command: python -m http.server $PORT
    memory: 256M
  sidecars:
  - name: consul
    process_types: [web]
    memory: 32M
    command: >-
      ./consul agent
      -node backend-$CF_INSTANCE_GUID
      -data-dir /tmp/consul
      -join consul-server.apps.internal
      -config-file backend.json
      -enable-local-script-checks
  - name: consul-proxy
    process_types: [web]
    memory: 64M
    command: sleep 10 && ./consul connect proxy -sidecar-for backend
